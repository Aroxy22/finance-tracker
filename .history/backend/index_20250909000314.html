<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Financial Tracker Bot</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    margin: 0;
    padding: 0;
    background: #f4f6f8;
    color: #333;
}
h1 { text-align: center; margin-top: 30px; color: #2c3e50; }
.container { max-width: 1000px; margin: auto; padding: 20px; }
.input-group, .filter-group { display: flex; justify-content: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
input[type=text], select { padding: 12px; flex: 1; min-width: 150px; border: 1px solid #ccc; border-radius: 8px; font-size: 16px; }
button { padding: 12px 20px; border: none; background-color: #3498db; color: white; cursor: pointer; font-size: 16px; border-radius: 8px; transition: background 0.3s; }
button:hover { background-color: #2980b9; }
#speechBtn { background-color: #e67e22; }
#speechBtn.off { background-color: #95a5a6; }
#response, #answer { margin: 10px 0; padding: 10px; background: #ecf0f1; border-radius: 8px; white-space: pre-wrap; }
#transactions table { width: 100%; border-collapse: collapse; margin-top: 15px; box-shadow: 0 4px 8px rgba(0,0,0,0.05); }
#transactions th, #transactions td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
#transactions th { background-color: #3498db; color: white; }
#transactions tr:nth-child(even) { background-color: #f2f2f2; }
#summary, #categorySummary { display: flex; justify-content: space-around; flex-wrap: wrap; gap: 15px; margin-top: 20px; }
.card { flex: 1; min-width: 200px; padding: 15px 20px; background: white; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
.card h3 { margin: 0 0 10px 0; }
.income { color: green; font-weight: bold; }
.expense { color: red; font-weight: bold; }
#notification { position: fixed; top: 20px; right: 20px; z-index: 1000; }
.notification-card { padding: 15px 20px; margin-bottom: 10px; border-radius: 10px; color: white; font-weight: 600; box-shadow: 0 4px 10px rgba(0,0,0,0.2); animation: slideIn 0.5s ease-out; max-width: 300px; word-wrap: break-word; }
@keyframes slideIn { 0% { transform: translateX(100%); opacity: 0; } 100% { transform: translateX(0); opacity: 1; } }
.delete-btn { padding: 4px 8px; background: #e74c3c; color: white; border: none; border-radius: 6px; cursor: pointer; }
.delete-btn:hover { background: #c0392b; }
.edit-btn { padding: 4px 8px; background: #f1c40f; color: white; border: none; border-radius: 6px; cursor: pointer; }
.edit-btn:hover { background: #d4ac0d; }
</style>
</head>
<body>
<div class="container">
    <h1>ðŸ’° Financial Tracker Bot</h1>

    <!-- Command Input -->
    <div class="input-group">
        <input type="text" id="textInput" placeholder="Type a command or amount...">
        <button onclick="sendText()">Send</button>
        <button id="speechBtn">ðŸŽ¤ Mic On</button>
        <button onclick="exportCSV()">Export CSV</button>
    </div>

    <!-- Filters -->
    <div class="filter-group">
        <select id="filterType" onchange="listTransactions()">
            <option value="">All Types</option>
            <option value="income">Income</option>
            <option value="expense">Expense</option>
        </select>
        <input type="text" id="searchText" placeholder="Search description..." oninput="listTransactions()">
    </div>

    <!-- Responses -->
    <div id="response"></div>

    <!-- Finance Q&A -->
    <div class="input-group">
        <input type="text" id="askInput" placeholder="Ask financial question...">
        <button onclick="sendQuestion()">Ask</button>
    </div>
    <div id="answer"></div>

    <!-- Summary -->
    <div id="summary">
        <div class="card">Income: <span class="income" id="incomeVal">$0.00</span></div>
        <div class="card">Expense: <span class="expense" id="expenseVal">$0.00</span></div>
        <div class="card">Balance: <span id="balanceVal">$0.00</span></div>
    </div>

    <!-- Category Summary -->
    <div id="categorySummary"></div>

    <!-- Transactions -->
    <div id="transactions">
        <h3>Transactions</h3>
        <table>
            <thead>
                <tr>
                    <th>ID</th><th>Description</th><th>Category</th><th>Amount</th>
                    <th>Expense?</th><th>Time</th><th>Actions</th>
                </tr>
            </thead>
            <tbody id="txBody"></tbody>
        </table>
    </div>
</div>

<div id="notification"></div>

<script>
const responseDiv = document.getElementById("response");
const txBody = document.getElementById("txBody");
const incomeVal = document.getElementById("incomeVal");
const expenseVal = document.getElementById("expenseVal");
const balanceVal = document.getElementById("balanceVal");
const categorySummary = document.getElementById("categorySummary");
const notificationDiv = document.getElementById("notification");

let allTransactions = [];

async function sendCommand(text){
    const res = await fetch("/api/command", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({text})
    });
    const data = await res.json();
    responseDiv.innerText = JSON.stringify(data, null, 2);

    if(data.status === "need_amount"){
        let amt = prompt(data.message);
        if(amt) sendCommand(`${data.description} ${amt}`);
        return;
    }

    if(data.status==="ok" && data.action==="added"){
        showNotification(data);
    } else if(data.status === "error"){
        showNotification({message: data.message, error:true});
    }

    listTransactions();
    showSummary();
    document.getElementById("textInput").value = "";
}

function sendText(){ const text = document.getElementById("textInput").value; if(text) sendCommand(text); }

async function listTransactions(){
    const res = await fetch("/api/command", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({text: "list"})
    });
    const data = await res.json();
    allTransactions = data.transactions || [];

    const filterType = document.getElementById("filterType").value;
    const searchText = document.getElementById("searchText").value.toLowerCase();

    const filtered = allTransactions.filter(tx => {
        let matchType = filterType ? (filterType==='income' ? !tx.is_expense : tx.is_expense) : true;
        let matchSearch = tx.desc.toLowerCase().includes(searchText);
        return matchType && matchSearch;
    });

    txBody.innerHTML = "";
    filtered.forEach(tx => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${tx.id}</td>
            <td>${tx.desc}</td>
            <td>${tx.category}</td>
            <td class="${tx.is_expense ? 'expense':'income'}">$${tx.amount.toFixed(2)}</td>
            <td>${tx.is_expense ? 'Yes':'No'}</td>
            <td>${new Date(tx.ts).toLocaleString()}</td>
            <td>
                <button class="edit-btn" onclick="editTransaction(${tx.id})">Edit</button>
                <button class="delete-btn" onclick="deleteTransaction(${tx.id})">Delete</button>
            </td>
        `;
        txBody.appendChild(tr);
    });

    showCategorySummary(filtered);
}

function showSummary(){
    let totalIncome = allTransactions.filter(t => !t.is_expense).reduce((a,b)=>a+b.amount,0);
    let totalExpense = allTransactions.filter(t => t.is_expense).reduce((a,b)=>a+b.amount,0);
    incomeVal.innerText = `$${totalIncome.toFixed(2)}`;
    expenseVal.innerText = `$${totalExpense.toFixed(2)}`;
    balanceVal.innerText = `$${(totalIncome-totalExpense).toFixed(2)}`;
}

function showCategorySummary(transactions){
    let summary = {};
    transactions.forEach(tx => { if(!summary[tx.category]) summary[tx.category]=0; summary[tx.category]+=tx.amount; });
    categorySummary.innerHTML = '';
    for(let cat in summary){
        const card = document.createElement('div');
        card.className='card';
        card.innerHTML=`<h3>${cat}</h3><p>Total: $${summary[cat].toFixed(2)}</p>`;
        categorySummary.appendChild(card);
    }
}

function showNotification(data){
    const notif=document.createElement("div");
    notif.className="notification-card";
    if(data.error){ notif.style.background="#e67e22"; notif.innerText=`Error: ${data.message}`; }
    else if(data.deleted_id!==undefined){ notif.style.background="#3498db"; notif.innerText=`Deleted transaction ID: ${data.deleted_id}`; }
    else if(data.id!==undefined){ notif.style.background=data.is_expense?"#e74c3c":"#2ecc71"; notif.innerText=`Transaction Added: ID:${data.id}, $${data.amount.toFixed(2)}, ${data.category}`; }
    notificationDiv.appendChild(notif);
    notif.scrollIntoView({behavior:"smooth"});
    setTimeout(()=> notif.remove(),4000);
}

async function deleteTransaction(id){ await sendCommand(`delete ${id}`); }
async function editTransaction(id){
    let tx = allTransactions.find(t=>t.id===id);
    if(!tx) return;
    let newDesc = prompt("Description:", tx.desc) || tx.desc;
    let newAmt = parseFloat(prompt("Amount:", tx.amount)) || tx.amount;
    let isExpense = confirm("Is Expense? (OK=Yes)") ? true : false;

    await fetch("/api/edit",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({id:id, description:newDesc, amount:newAmt, is_expense:isExpense})
    });
    listTransactions();
    showSummary();
}

async function sendQuestion(){
  const text = document.getElementById("askInput").value;
  if(!text) return;

  const res = await fetch("/api/ask", {
      method:"POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({text})
  });

  const data = await res.json();

  if(data.status === "ok"){
      document.getElementById("answer").innerHTML = data.answer;
  } else {
      document.getElementById("answer").innerHTML = `<span style="color:red;">Error: ${data.message || "Unknown error"}</span>`;
  }

  document.getElementById("askInput").value = "";
}


async function exportCSV(){
    let csv="ID,Description,Category,Amount,Expense,Date\n";
    allTransactions.forEach(t=>{csv+=`${t.id},"${t.desc}",${t.category},${t.amount},${t.is_expense?1:0},${t.ts}\n`;});
    const blob = new Blob([csv], {type:"text/csv"});
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "transactions.csv";
    link.click();
}

// Speech recognition
const speechBtn = document.getElementById("speechBtn");
let recognition, micOn=false;
if('webkitSpeechRecognition' in window){
    recognition = new webkitSpeechRecognition();
    recognition.continuous=true;
    recognition.interimResults=true;
    recognition.lang="en-US";
    recognition.onresult=function(event){
        let transcript = event.results[event.results.length-1][0].transcript;
        document.getElementById("textInput").value = transcript;
    };
    recognition.onerror=function(event){ alert("Speech error: "+event.error); };
    speechBtn.onclick=()=>{
        if(!micOn){ recognition.start(); micOn=true; speechBtn.innerText="ðŸŽ¤ Mic Off"; speechBtn.classList.remove("off"); }
        else{ recognition.stop(); micOn=false; speechBtn.innerText="ðŸŽ¤ Mic On"; speechBtn.classList.add("off"); }
    };
}else{ speechBtn.disabled=true; speechBtn.innerText="Mic not supported"; }

listTransactions();
showSummary();
</script>
</body>
</html>
